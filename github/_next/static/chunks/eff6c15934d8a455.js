(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,1521,(e,t,n)=>{"use strict";Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"warnOnce",{enumerable:!0,get:function(){return c}});let c=e=>{}},79537,e=>{e.v({AElig:"Æ",AMP:"&",Aacute:"Á",Acirc:"Â",Agrave:"À",Aring:"Å",Atilde:"Ã",Auml:"Ä",COPY:"©",Ccedil:"Ç",ETH:"Ð",Eacute:"É",Ecirc:"Ê",Egrave:"È",Euml:"Ë",GT:">",Iacute:"Í",Icirc:"Î",Igrave:"Ì",Iuml:"Ï",LT:"<",Ntilde:"Ñ",Oacute:"Ó",Ocirc:"Ô",Ograve:"Ò",Oslash:"Ø",Otilde:"Õ",Ouml:"Ö",QUOT:'"',REG:"®",THORN:"Þ",Uacute:"Ú",Ucirc:"Û",Ugrave:"Ù",Uuml:"Ü",Yacute:"Ý",aacute:"á",acirc:"â",acute:"´",aelig:"æ",agrave:"à",amp:"&",aring:"å",atilde:"ã",auml:"ä",brvbar:"¦",ccedil:"ç",cedil:"¸",cent:"¢",copy:"©",curren:"¤",deg:"°",divide:"÷",eacute:"é",ecirc:"ê",egrave:"è",eth:"ð",euml:"ë",frac12:"½",frac14:"¼",frac34:"¾",gt:">",iacute:"í",icirc:"î",iexcl:"¡",igrave:"ì",iquest:"¿",iuml:"ï",laquo:"«",lt:"<",macr:"¯",micro:"µ",middot:"·",nbsp:" ",not:"¬",ntilde:"ñ",oacute:"ó",ocirc:"ô",ograve:"ò",ordf:"ª",ordm:"º",oslash:"ø",otilde:"õ",ouml:"ö",para:"¶",plusmn:"±",pound:"£",quot:'"',raquo:"»",reg:"®",sect:"§",shy:"­",sup1:"¹",sup2:"²",sup3:"³",szlig:"ß",thorn:"þ",times:"×",uacute:"ú",ucirc:"û",ugrave:"ù",uml:"¨",uuml:"ü",yacute:"ý",yen:"¥",yuml:"ÿ"})},27208,e=>{e.v({0:"�",128:"€",130:"‚",131:"ƒ",132:"„",133:"…",134:"†",135:"‡",136:"ˆ",137:"‰",138:"Š",139:"‹",140:"Œ",142:"Ž",145:"‘",146:"’",147:"“",148:"”",149:"•",150:"–",151:"—",152:"˜",153:"™",154:"š",155:"›",156:"œ",158:"ž",159:"Ÿ"})},73850,e=>{"use strict";var t=e.i(45100);let n=(0,e.i(51849).createIcon)({iconProps:{useFillCurrentColor:!0},viewBox:"0 0 156 94",paths:(0,t.jsx)("path",{d:"M0,31.18h31.18v62.56H0V31.18Zm155.46,5.67v56.89h-31.18V45.36c0-7.83-6.34-14.18-14.17-14.18h-17.01c.29,1.85,.44,3.74,.44,5.67v56.89h-31.18V45.36c0-7.83-6.35-14.18-14.17-14.18H31.18V0h25.51c13.15,0,24.69,6.89,31.21,17.25,2.62,4.15,4.43,8.86,5.2,13.92V0h25.51c20.35,0,36.85,16.5,36.85,36.85Z"})});e.s(["IconMLogo",0,n])},7823,e=>{"use strict";function t(e,t){if(null==e)return{};var n={};for(var c in e)if(({}).hasOwnProperty.call(e,c)){if(-1!==t.indexOf(c))continue;n[c]=e[c]}return n}e.s(["default",()=>t])},37215,e=>{"use strict";function t(){return(t=Object.assign.bind()).apply(null,arguments)}e.s(["default",()=>t])},22480,e=>{"use strict";let t=(0,e.i(64334).createContext)({currentId:"",onLinkClick:()=>{},linkMap:{current:new Map}});e.s(["AnchorContext",0,t])},98319,e=>{"use strict";var t=e.i(64334);function n(...e){return(0,t.useCallback)(t=>{e.forEach(e=>{"function"==typeof e?e(t):null!=e&&(e.current=t)})},e)}e.s(["useComposedRefs",()=>n])},88036,59013,e=>{"use strict";var t=e.i(45100),n=e.i(64334),c=e.i(22480);function r(e){let t=(0,n.useRef)(null);return t.current=e,(0,n.useCallback)((...e)=>t.current?.(...e),[])}e.s(["useEvent",()=>r],59013);var s=e.i(96224);function l(e,t){try{return e.querySelector(t)}catch(e){return null}}function i({scrollContainer:e,targetId:t,offset:n,isScrolling:c}){var r,i;if(!t)return;let o=l(document,`#${CSS.escape(t)}`);if(!o)return;let d=e.current,u=((void 0===(r=d)&&(r=window),r)&&(r===window?Math.ceil(window.pageYOffset):r.scrollTop)||0)+((e,t)=>{if(!e.getClientRects().length)return 0;let n=e.getBoundingClientRect();return n.width||n.height?t&&t!==window?n.top-t.getBoundingClientRect().top:(t=e.ownerDocument.documentElement,n.top-t.clientTop):n.top})(o,d)+n;(c.current=!0,(0,s.isWindow)(d))?d.scrollTo((void 0===(i=d)&&(i=window),i)&&(i===window?Math.ceil(window.pageXOffset||window.scrollX):i.scrollLeft)||0,u):d.scrollTop=u}function o({targetId:e,linkMap:t,wrapperRef:n,currentId:c,setCurrentId:r,onChange:s}){e&&n.current&&t.current.get(e)&&e!==c&&r(e).then(()=>{s?.(e,c)})}var d=e.i(98319);let u=(0,n.forwardRef)((e,u)=>{let{scrollContainer:a,offset:h=0,children:x,onChange:j,queryKey:m="anchor-id",isCloseInitAnchor:p,...f}=e,{currentId:g,onLinkClick:v,wrapperRef:C,linkMap:S}=function({propScrollContainer:e,onChange:t,offset:c,queryKey:d,isCloseInitAnchor:u}){var a;let h,x,j=(0,n.useRef)(null),m=(0,n.useRef)(null),p=(0,n.useRef)(new Map),f=(0,n.useRef)(!1),[g,v]=function(e){let[t,c]=(0,n.useState)({value:"",resolve:e=>{}});return(0,n.useEffect)(()=>{t.resolve(t.value)},[t]),[t.value,e=>new Promise(t=>{c(n=>{let c=e;return"function"==typeof e&&(c=e(n.value)),{value:c,resolve:t}})})]}(0),C=r(()=>{if(f.current)return;let e=function({linkMap:e,scrollContainer:t}){let n=t.current,c=((0,s.isWindow)(n)?document.documentElement||document.body:n).getBoundingClientRect(),r=Array.from(e.current.keys()),i=[];for(let e of r){let t=l(document,"#"+CSS.escape(e));if(t){let{top:e}=t.getBoundingClientRect(),r=(0,s.isWindow)(n)?e:e-c.top;r>=0&&i.push({element:t,top:r})}}return 0===i.length?null:i.reduce((e,t)=>e.top<=t.top?e:t).element}({linkMap:p,scrollContainer:m});e?.id&&o({targetId:e.id,linkMap:p,wrapperRef:j,currentId:g,setCurrentId:v,onChange:t})}),S=r((a=()=>{C(),f.current=!1},h=null,(x=(...e)=>{h||(h=setTimeout(()=>{h=null,a(...e)},30))}).cancel=()=>{h&&(clearTimeout(h),h=null)},x));return(0,n.useEffect)(()=>(m.current=(0,s.isString)(e)?l(document,e):e||window,m.current?.addEventListener("scroll",S),()=>{m.current?.removeEventListener("scroll",S)}),[S,e]),(0,n.useEffect)(()=>{if(!u)return void S();let e=new URLSearchParams(new URL(window.location.href).search).get(d);e&&(o({targetId:e,linkMap:p,wrapperRef:j,currentId:g,setCurrentId:v,onChange:t}),i({scrollContainer:m,targetId:e,offset:c,isScrolling:f}))},[]),{onScroll:S,currentId:g,onLinkClick:function(e,n){e.preventDefault(),o({targetId:n,linkMap:p,wrapperRef:j,currentId:g,setCurrentId:v,onChange:t}),i({scrollContainer:m,targetId:n,offset:c,isScrolling:f})},wrapperRef:j,scrollContainer:m,linkMap:p}}({propScrollContainer:a,onChange:j,offset:h,queryKey:m,isCloseInitAnchor:p});return(0,t.jsx)(c.AnchorContext.Provider,{value:{currentId:g,linkMap:S,onLinkClick:v},children:(0,t.jsx)("div",{...f,ref:(0,d.useComposedRefs)(C,u),children:x})})});e.s(["Anchor",0,u],88036)},69438,e=>{"use strict";var t=e.i(45100),n=e.i(64334),c=e.i(22480),r=e.i(98319);let s=(0,n.forwardRef)((e,s)=>{let{onLinkClick:l,linkMap:i,currentId:o}=(0,n.useContext)(c.AnchorContext),{onClick:d,targetId:u,children:a,className:h,activeClassName:x,...j}=e,m=(0,n.useRef)(null);return(0,n.useEffect)(()=>{var e;return e=m.current,u&&i.current.set(u,e),()=>{i.current.delete(u)}},[u,i]),(0,t.jsx)("div",{ref:(0,r.useComposedRefs)(s,m),...j,onClick:e=>{e.stopPropagation(),d?.(e),l?.(e,u)},"data-target-id":u,className:o===u?x:h,children:a})});e.s(["AnchorLink",0,s],69438)},93562,e=>{"use strict";var t=e.i(88036),n=e.i(69438),c=e.i(22480);let r={Root:t.Anchor,Link:n.AnchorLink,Context:c.AnchorContext};e.s(["Anchor",()=>r])},42121,e=>{"use strict";var t=e.i(45100),n=e.i(18694);e.i(82928);var c=e.i(72304),r=e.i(2697),s=e.i(47445),l=e.i(69389),i=e.i(18805);function o(e){let o={code:"code",h2:"h2",p:"p",...(0,n.useMDXComponents)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(l.H1,{children:"Next.js 换肤方案"}),"\n",(0,t.jsx)(r.AvatarM,{}),"\n",(0,t.jsx)(c.ImageTypography,{src:"/solution/theme.webp",fill:!0,alt:"button",containerClassName:"h-96"}),"\n",(0,t.jsx)(o.h2,{children:"介绍"}),"\n",(0,t.jsxs)(o.p,{children:["之前介绍了 ",(0,t.jsx)(i.Link,{href:"/solution/theme/css",children:"Css 换肤方案"})," 和 ",(0,t.jsx)(i.Link,{href:"/solution/theme/tailwind",children:"Tailwind 换肤方案"}),"，其实这两种都是基于普通的 ",(0,t.jsx)(o.code,{children:"SPA"})," 架构的页面，毕竟国内 ",(0,t.jsx)(o.code,{children:"SPA"})," 还是主流。但在国外 ",(0,t.jsx)(o.code,{children:"Next.js"})," 这种全栈框架非常流行。（\n我个人不太喜欢用这种框架，Nextjs 也只是主要是用其 ",(0,t.jsx)(o.code,{children:"SSG"})," 的功能，这种框架对于简单的后端来说还挺方便的，但是复杂度一旦上去了，",(0,t.jsx)(o.code,{children:"Next.js"})," 对于 react 有非常多限制，而且后端性能并不出色，所以\n我通常还是喜欢前后端分离的架构，后端用正常的 ",(0,t.jsx)(o.code,{children:"Node.js"})," 框架即可）。"]}),"\n",(0,t.jsxs)(o.p,{children:[(0,t.jsx)(o.code,{children:"next.js"}),"的主题色和国际化都远不如 ",(0,t.jsx)(o.code,{children:"SPA"})," 页面那样容易，因为 ",(0,t.jsx)(o.code,{children:"SPA"}),"（单页Web应用） 页面的 ",(0,t.jsx)(o.code,{children:"HTML"})," 都是靠 ",(0,t.jsx)(o.code,{children:"javascript"})," 生成的，那么我们在\n所以我们在 ",(0,t.jsx)(o.code,{children:"React"})," 、 ",(0,t.jsx)(o.code,{children:"Vue"})," 等等这些框架中，可以先获得 ",(0,t.jsx)(o.code,{children:"localstorage"})," 中的主题值，然后再赋值给 html 的 ",(0,t.jsx)(o.code,{children:"class"})," 属性，然后框架在第一次初始化时，渲染出 html 元素。"]}),"\n",(0,t.jsxs)(o.p,{children:["但是 ",(0,t.jsx)(o.code,{children:"next.js"})," 它是已经生成好 ",(0,t.jsx)(o.code,{children:"HTML"})," 了，我们如果还使用 ",(0,t.jsx)(o.code,{children:"SPA"})," 架构那套在 js 中注入 ",(0,t.jsx)(o.code,{children:"CSS"})," 变量，就会出现页面刚开始没有主题色，然后闪一下，换颜色。"]}),"\n",(0,t.jsxs)(o.p,{children:["所以我们必须要在 HTML 呈现之前，就把 ",(0,t.jsx)(o.code,{children:"CSS"})," 注入，这就是一个技术难题了。"]}),"\n",(0,t.jsxs)(o.p,{children:["在 ",(0,t.jsx)(o.code,{children:"next.js"})," 中有一个库叫做 ",(0,t.jsx)(o.code,{children:"next-themes"}),", 专门解决这个问题。"]}),"\n",(0,t.jsx)(o.p,{children:"我把这个库的逻辑精简了很多，自己手写了一个精简版用到了自己的项目中，接下来我就来介绍一下主要实现逻辑。"}),"\n",(0,t.jsx)(o.h2,{children:"css 变量换肤思路"}),"\n",(0,t.jsxs)(o.p,{children:["上面的两篇文章其实已经讲了很多 ",(0,t.jsx)(o.code,{children:"CSS"})," 变量的换肤思路的，请从上面 ",(0,t.jsx)(o.code,{children:"CSS 换肤方案"})," 这篇文章了解具体思路。"]}),"\n",(0,t.jsx)(o.p,{children:"简单来说就是："}),"\n",(0,t.jsxs)(o.p,{children:["我们在 html 标签中添加 ",(0,t.jsx)(o.code,{children:"class"})," 属性，值为 ",(0,t.jsx)(o.code,{children:"light"})," 或者 ",(0,t.jsx)(o.code,{children:"dark"}),"，这样我们就可以根据 ",(0,t.jsx)(o.code,{children:"class"})," 的值，来切换主题。"]}),"\n",(0,t.jsx)(s.CodeBlock,{code:'<html class="light"></html>',language:"html"}),"\n",(0,t.jsxs)(o.p,{children:["然后所有主题需要的 ",(0,t.jsx)(o.code,{children:"CSS"})," 变量定义如下，例如亮色主题为："]}),"\n",(0,t.jsx)(s.CodeBlock,{code:`html.light {
  --primary-blue-600: #366ef4;
  --primary-blue-500: #2557e7;
  --primary-blue-200: #c3dafe;
  --primary-blue-700: #204ed6;
  --primary-blue-300: #93c5fd;
  /* .... */
}`,language:"css"}),"\n",(0,t.jsx)(o.h2,{children:"服务器端获取不到 localstorage"}),"\n",(0,t.jsxs)(o.p,{children:["因为 ",(0,t.jsx)(o.code,{children:"next.js"})," 是在服务器已经渲染好 ",(0,t.jsx)(o.code,{children:"HTML"})," 了，所以我们在服务器端是获取不到 ",(0,t.jsx)(o.code,{children:"localStorage"})," 的。"]}),"\n",(0,t.jsxs)(o.p,{children:["这就意味着无论是 ",(0,t.jsx)(o.code,{children:"vue"})," 还是 ",(0,t.jsx)(o.code,{children:"react"})," 初次渲染当然在服务端拿不到客户端的 ",(0,t.jsx)(o.code,{children:"localStorage"}),"。可 ",(0,t.jsx)(o.code,{children:"CSS 变量"})," 换肤，需要初始化的时候获取到客户端的 ",(0,t.jsx)(o.code,{children:"localstorage"}),"。"]}),"\n",(0,t.jsx)(o.p,{children:"这可怎么办呢？"}),"\n",(0,t.jsx)(o.h2,{children:"Script 阻塞 dom 渲染"}),"\n",(0,t.jsxs)(o.p,{children:["这是一个面试常见的问题，就是 ",(0,t.jsx)(o.code,{children:"script"})," 标签是否会阻塞 ",(0,t.jsx)(o.code,{children:"DOM"})," 渲染？"]}),"\n",(0,t.jsxs)(o.p,{children:["如果不考虑 ",(0,t.jsx)(o.code,{children:"script"})," 标签的 ",(0,t.jsx)(o.code,{children:"async"})," 和 ",(0,t.jsx)(o.code,{children:"defer"})," 属性，",(0,t.jsx)(o.code,{children:"script"})," 会阻塞 ",(0,t.jsx)(o.code,{children:"DOM"})," 渲染。\n所以一般 ",(0,t.jsx)(o.code,{children:"script"})," 标签建议放到 ",(0,t.jsx)(o.code,{children:"body"})," 标签之后，这样可以避免阻塞 ",(0,t.jsx)(o.code,{children:"DOM"})," 渲染。"]}),"\n",(0,t.jsxs)(o.p,{children:["但是这里我们反而要反之其道行之，把 ",(0,t.jsx)(o.code,{children:"script"})," 放到 ",(0,t.jsx)(o.code,{children:"head"})," 标签上，这样我们就可以在页面渲染前，更改 ",(0,t.jsx)(o.code,{children:"HTML"})," 属性。"]}),"\n",(0,t.jsxs)(o.p,{children:["这就是我们初始化页面 ",(0,t.jsx)(o.code,{children:"HTML"})," 的思路。"]}),"\n",(0,t.jsx)(o.p,{children:"类似如下的代码："}),"\n",(0,t.jsx)(s.CodeBlock,{code:`// defaultTheme 是值默认主题色，themeKey 是指 localStorage 中的主题色的 key 值
const script = (defaultTheme: ThemeTypeProps, themeKey: string) => {
  const theme = localStorage.getItem(themeKey) || defaultTheme;
  localStorage.setItem(themeKey, theme);
  document.documentElement.setAttribute('class', theme);
};
`,language:"javascript"}),"\n",(0,t.jsx)(o.h2,{children:"封装为 React 组件"}),"\n",(0,t.jsxs)(o.p,{children:["上面虽然解决了初始化的问题，但是毕竟是 ",(0,t.jsx)(o.code,{children:"React"})," 组件，我们给子组件共享当前的主题是什么和修改主题的方法。"]}),"\n",(0,t.jsxs)(o.p,{children:["所以我们可以用 ",(0,t.jsx)(o.code,{children:"React Context"})," 来实现。"]}),"\n",(0,t.jsx)(s.CodeBlock,{code:`const NextLocalStorage = ({ defaultTheme, children, nonce, scriptContent, themeKey = THEME }: LocalstorageProviderProps) => {
  const [theme, setTheme] = useState<ThemeTypeProps | undefined>(undefined);
  const setThemeState = useCallback(
    (value: ThemeTypeProps) => {
      setTheme(value);
      // 然后修改 localstorage 的信息
      saveToLS(themeKey, value);
    },
    [themeKey],
  );
  useEffect(() => {
    // 后续 theme 变化，更新 html class 对应的主题样式
    if (!theme) return;
    document.documentElement.classList = '';
    document.documentElement.classList.add(theme as ThemeTypeProps);
  }, [theme]);
  // 共享当前主题色和修改主题的方法给子组件用
  const providerValue = useMemo(
    () => ({
      theme,
      themeKey,
      setThemeState,
    }),
    [setThemeState, theme, themeKey],
  );
  return (
    <LocalstorageContext value={providerValue}>
      {/* ThemeScript 组件就是注入 script 初始化主题的组件 */}
      <ThemeScript />
      {children}
    </LocalstorageContext>
  );
};
`,language:"typescript"}),"\n",(0,t.jsx)(o.h2,{children:"细节注意"}),"\n",(0,t.jsx)(o.p,{children:"就是如果我们浏览器开了多个标签，那么如何实现，当某个标签的主题切换之后，另一个标签页的主题也能更新呢？"}),"\n",(0,t.jsxs)(o.p,{children:["这里我们可以利用 ",(0,t.jsx)(o.code,{children:"storage"})," 事件来处理。用法如下"]}),"\n",(0,t.jsx)(s.CodeBlock,{code:'window.addEventListener("storage", handleStorage, false);',language:"typescript"}),"\n",(0,t.jsxs)(o.p,{children:["这里我们可以注册一个 ",(0,t.jsx)(o.code,{children:"handleStorage"}),", 用来上面已经定义好的修改主题的方法 ",(0,t.jsx)(o.code,{children:"setThemeState"})," 来通知所有页签。"]})]})}function d(e={}){let{wrapper:c}={...(0,n.useMDXComponents)(),...e.components};return c?(0,t.jsx)(c,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}function u(){return(0,t.jsx)(d,{})}e.s(["ThemeNextSolution",()=>u],42121)}]);